DefaultStyleOptions =  {
    audioInfo:{
        marginBottom:"5px",
        width:"100%"
    },
    audioInfoDescContainer:{
        alignItems: "flexStart",
        display: "flex",
        flexDirection: "column",
        fontSize:"12px",
        justifyContent: "space-between",
        paddingLeft:"10px",
        paddingRight:"10px",
        width: "100%"
    },
    audioInfoImage: {
        height:"100px",
        width:"100px"
     },
     controlItem :{
      alignItems: "center",
      border:"1px solid #f88",
      backgroundColor: "#f88",
      borderRadius: "30px",
      display: "flex",
      flexGrow: "0",
      height: "36px",
      justifyContent: "center",
      padding: "20px 0",
      width:"36px"
    },
    controls: {
        alignItems: "center",
        display: "flex",
        flexDirection: "row",
        justifyContent: "space-around",
        width: "100%"
    },
    cpplayer:{
        backgroundColor: "#111188",
        border:"2px solid #009",
        borderRadius: "8px",
        boxSizing: "border-box",
        dislay: "flex",
        flexDirection: "column",
        marginBottom:"16px",
        padding:"16px"
    },
    muteBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width:"16px"
    },
    nextTrackBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width:"16px"
    },
    prevTrackBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width:"16px"
    },
    playBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        borderRadius: "50%",
        boxShadow: "1px 1px 1px 1px #aaa",
        color:"#000",
        display: "flex",
        fontSize: "24px",
        height:"60px",
        justifyContent: "center",
        padding:"18px",
        width:"60px"
    },
    pauseBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        borderRadius: "50%",
        boxShadow: "1px 1px 1px 1px #aaa",
        color:"#000",
        display: "flex",
        fontSize: "24px",
        height:"60px",
        justifyContent: "center",
        padding:"18px",
        width:"60px"
    },
    PlaylistPlayIcons:{
        fontSize: "10px"
    },
    playlistBtn:{
        backgroundColor: "#f88",
        borderRadius: "5px",
        border: "1px solid #000",
        color: "#000",
        display: "flex",
        flexDirection: "column",
        gap: "10px",
        margin: "10px 0",
        padding: "10px"
    },
    progressBar:{
        borderRadius: "5px",
        backgroundColor: "#fff",
        display: "flex",
        flexDirection: "row",
        height: "5px",
        margin: "20px 0",
        position: "relative",
        width:"80%"
    },
    playlist : {
        backgroundColor: "#fff",
        borderRadius: "5px",
        height: "100px",
        overflowY: "scroll",
        padding: "10px",
        scrollbarWidth: "none",
        width: "100%"
    },
    row1:{
        display: "flex",
        flexDirection: "column",
        justifyContent: "space-between",
        alignItems: "center",
        width: "100%"
    },
    row2:{
        alignItems: "center",
        display: "flex",
        flexDirection: "row",
        justifyContent: "space-between",
        marginTop: "8px",
        width: "100%"
    },
    seekBar:{
        backgroundColor: "#000",
        borderRadius: "5px",
        height: "100%",
        width:"0%"
    },
    seekControls:{
        backgroundColor: "transparent",
        border:"none",
        display: "flex",
        flexDirection: "row",
        justifyContent: "space-between",
        width:"75px"
    },
    seekForwardBtn:{
        alignItems: "center",
        border:"1px solid #fff",
        backgroundColor: "#fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width:"16px"
    },
    seekBackwardBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width: '16px'
    },
    timelapse : {
        color: "#fff",
        fontSize: "12px",
        marginLeft: "5px",
        marginRight: "5px",
        textAlign: "left",
        width:"auto"
    },
    timeline:{
        alignItems: "center",
        display: "flex",
        flexDirection: "row",
        justifyContent: "center",
        width:"100%"
    },
    track:{
        alignItems: "center",
        borderBottom: "1px solid #888",
        display: "flex",
        flexDirection: "row",
        justifyContent: "space-between",
        padding: "5px"
    },
    togglePlaylistBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        flexGrow: "0",
        height: "16px",
        justifyContent: "center",
        padding: "12px",
        width:"16px"
    },
    trackControls:{
        backgroundColor: "transparent",
        border:"none",
        display: "flex",
        flexDirection: "row",
        justifyContent: "space-between",
        width:"75px"
    },
    unmuteBtn:{
        alignItems: "center",
        backgroundColor: "#fff",
        border:"1px solid #fff",
        borderRadius: "30px",
        boxShadow: "1px 1px 1px 1px #aaa",
        color: "#000",
        display: "flex",
        width:"16px",
        height: "16px",
        justifyContent: "center",
        flexGrow: "0",
        padding: "12px"
    },
    volContainer:{
        display: 'flex',
        flexDirection: 'row',
        justifyContent: 'space-between',
        width: '120px'
    },
    volumeControl: {
        '-webkit-appearance': 'none',
        appearance: 'none',
        height: '5px',
        marginTop: '10px',
        backgroundColor : '#dddddd',
        width:'70%'
    }
};
class CP_Player{
    constructor(playlist, options, playerId, styleOptions={}){
        this.playlist = playlist;
        this.trackIndex = 0;
        this.playerVolume = 10;
        this.currentTrack = this.playlist[this.trackIndex];

        this.music = new Audio(this.currentTrack);
        this.options = options;
        this.activeAudioTags = {};

        this.amination_audioContext = null;
        this.anmation_analyser = null;
        this.animation_source = null;
        this.animation_dataArray = null;

        if(this.options.useFontAwesome){
            this.loadFontAwesome();
        }
        let dso = JSON.parse(JSON.stringify(DefaultStyleOptions));
        this.styleOptions = this.deepMerge(
            dso,
            styleOptions
        );
        // Create and append the player HTML dynamically
        const appContainer = document.getElementById(playerId); // Parent container
        this.playerSection = this.createPlayerDOM(playerId);
        appContainer.replaceWith(this.playerSection);

        this.initUI(playerId);
        this.initEventListeners();
        this.renderPlaylist();

        this.applyStyles(this.styleOptions);
    
    }

    loadFontAwesome() {
        // Check if FontAwesome is already loaded
        if (!document.querySelector("link[href*=\"fontawesome\"]")) {
            let link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css";
            document.head.appendChild(link);
        }
    }
     // Recursive deep merge function
     deepMerge(target, source){
        let isObject = (obj)=> obj && typeof obj === "object";
        for(let key in source) {
            if (isObject(source[key])) {
                if (!target[key] || !isObject(target[key])) {
                    target[key] = {}; // Ensure target[key] is an object
                }
                this.deepMerge(target[key], source[key]); // Recursive merge
            } else {
                target[key] = source[key]; // Assign non-object value
            }
        }
        return target;
    }

    createPlayerDOM(playerId) {
        // Create the main player section
        const playerSection = document.createElement("player");
        playerSection.classList.add("cpplayer");
        playerSection.id = playerId;

        const row1 = document.createElement("div");
        row1.className = "row1";

        const row2 = document.createElement("div");
        row2.className = "row2";

        if(this.options.audioInfo){
        const infodiv = document.createElement("div");
        infodiv.className = "audioInfo";

        const infoImage = document.createElement("img");
        infoImage.className = "audioInfoImage";
        infoImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKYAAACUCAMAAAAu5KLjAAAATlBMVEXv8fNod4dgcIH3+Prr7e91g5GdprDk5+pUZnjY3ODz9PZldIXf4+b5+vpcbX5aa32krLWSnaeqsrp9ipe+xMuzusLR1dqKlqHKz9W4v8UC8A7gAAACeklEQVR4nO2a7ZaCIBCGFQptKEXRsvu/0bXNTexjYzEZ95z3Of306NMMDCOSJAAAAAAAAAAAAAAAAAAAAAA8QslmPrS45fG0nY012dKWqdDzKeyy8dycRPoJ8kYuqZlt9Uc0hTpA879plnkoIqJm2e1DqXQ8zXwXOFGJlIipGVr3oOkAzU/yTJMk9T/PG3BpkuxaU58zz8cyadLOai2ETo1fE8mjKRs9rJ6l9fJk0aR9cVvji2q9mtbpRHTj4cmhSbtp1+NxAxbNxm3rtN2sVLN1Xzn01uNFjEXzPNG0rmZf8Q9PxiqL5nEyNivnQnm0qe1+0Yzxynarm69mOjW5TnVuHmR4CtIxH4Npx8vkMLfK9t6TaRVqxRBPkY6rkDyXPzXf3I1PrjW9s7kQohAqG7uRc3GLcXmXd7YOKevUqap3iRNLd/4X9cSTs988HJx+k9o8dSkVuRevpHuf1tIh786fWIembB/3woRZm+Z9xofxOeZ9FZrPYnkdnz95X4OmrIunlt9NHq1F83nGh7xX13jya77K+OB5ne/smtK8juU1npe883RII1SXv1r28+iSd+ZoUv3+28GlLrFqEr3J+C3vklXzZSW69zwYPk0yvl+LhFJRN7Xdpscv44OnTrk0vWPpRjV2W0zKb1yyalJi3tXLVWgGZDy6JlEVEsvYux6JCrOMqtlbhn5dj6gZnPGomn0sAypRbE3aVOGWEaMZnvGYmtWssymxNGfFMpamtjPP+UQ66zH3YApOzvwjzY39kKZZVJOCV/Ep4ccb/DT321LMJ1920+Oyg92o2dShx5j+gPwAi5+GBQAAAAAAAAAAAAAAAAAAAGBJvgD+5DZit7mvxgAAAABJRU5ErkJggg==";
        infoImage.alt = "Album Cover";
        infodiv.appendChild(infoImage);

        const infoDescContainer = document.createElement("div");
        infoDescContainer.className = "audioInfoDescContainer";
        infodiv.appendChild(infoDescContainer);

        const infoTitle = document.createElement("div");
        infoTitle.className = "audioInfoTitle";
        infoTitle.innerHTML = "<i class=\"fa-solid fa-music\"></i> Unknown";
        infoDescContainer.appendChild(infoTitle);

        const infoAlbum = document.createElement("div");
        infoAlbum.className = "audioInfoAlbum";
        infoAlbum.innerHTML = "<i class=\"fa-solid fa-book\"></i> Unknown";
        infoDescContainer.appendChild(infoAlbum);

        const infoArtist = document.createElement("div");
        infoArtist.className = "audioInfoArtist";
        infoArtist.innerHTML = "<i class=\"fa-solid fa-user\"></i> Unknown";
        infoDescContainer.appendChild(infoArtist);

        const infoYear = document.createElement("div");
        infoYear.className = "audioInfoYear";
        infoYear.innerHTML = "<i class=\"fa-solid fa-calendar\"></i> Unknown";
        infoDescContainer.appendChild(infoYear);
        row1.appendChild(infodiv);
        this.createDancingBars(infodiv);
        }
        // Create the controls container
        const controlsDiv = document.createElement("div");
        controlsDiv.className = "controls";

        // Play button
        const playBtn = document.createElement("div");
        playBtn.className = "playBtn";
        const playIcon = document.createElement("i");
        playIcon.className = "fa-solid fa-play";
        playBtn.appendChild(playIcon);
        controlsDiv.appendChild(playBtn);

        // Pause button
        const pauseBtn = document.createElement("div");
        pauseBtn.className = "pauseBtn hide";
        const pauseIcon = document.createElement("i");
        pauseIcon.className = "fa-solid fa-pause";
        pauseBtn.appendChild(pauseIcon);
        controlsDiv.appendChild(pauseBtn);

        if(this.options.showSoundControl) {
            const volContainer = document.createElement('div');
            volContainer.className = 'vol-container';

            // Mute button
            const muteBtn = document.createElement("div");
            muteBtn.className = "muteBtn";
            const muteIcon = document.createElement("i");
            muteIcon.className = "fa-solid fa-volume-high";
            muteBtn.appendChild(muteIcon);
            volContainer.appendChild(muteBtn);

            // Unmute button
            const unmuteBtn = document.createElement("div");
            unmuteBtn.className = "unmuteBtn hide";
            const unmuteIcon = document.createElement("i");
            unmuteIcon.className = "fa-solid fa-volume-xmark";
            unmuteBtn.appendChild(unmuteIcon);
            volContainer.appendChild(unmuteBtn);

            // volume control
            const volumeControl = document.createElement('input');
            volumeControl.type = 'range';
            volumeControl.className = 'volume-control';
            volumeControl.value = parseInt(this.playerVolume) * 10;
            volumeControl.max = 10;
            volumeControl.min = 0;
            volumeControl.step = 1;
            volContainer.appendChild(volumeControl);

            controlsDiv.appendChild(volContainer);

        }
        // Seek controls
        const seekControlsDiv = document.createElement("div");
        seekControlsDiv.className = "seekControls";
        const seekBackward = document.createElement("div");
        seekBackward.className = "seekBackward";
        const seekBackwardIcon = document.createElement("i");
        seekBackwardIcon.className = "fa-solid fa-share fa-flip-horizontal";
        seekBackward.appendChild(seekBackwardIcon);
        seekControlsDiv.appendChild(seekBackward);
        if(this.options.seekControls){
            const seekForward = document.createElement("div");
            seekForward.className = "seekForward";
            const seekForwardIcon = document.createElement("i");
            seekForwardIcon.className = "fa-solid fa-share";
            seekForward.appendChild(seekForwardIcon);
            seekControlsDiv.appendChild(seekForward);
            controlsDiv.appendChild(seekControlsDiv);
        }
        if(this.options.nextPreviousControls){
        // Track controls
        const trackControlsDiv = document.createElement("div");
        trackControlsDiv.className = "trackControls";
        const prevTrack = document.createElement("div");
        prevTrack.className = "prevTrack";
        const prevTrackIcon = document.createElement("i");
        prevTrackIcon.className = "fa-solid fa-backward-step";
        prevTrack.appendChild(prevTrackIcon);
        trackControlsDiv.appendChild(prevTrack);
        const nextTrack = document.createElement("div");
        nextTrack.className = "nextTrack";
        const nextTrackIcon = document.createElement("i");
        nextTrackIcon.className = "fa-solid fa-forward-step";
        nextTrack.appendChild(nextTrackIcon);
        trackControlsDiv.appendChild(nextTrack);
        controlsDiv.appendChild(trackControlsDiv);
        }

        const timeline = document.createElement("div");
        timeline.className = "timeline";

        if(this.options.showTimeLapse){
            const timelapse = document.createElement("div");
            timelapse.className = "timelapse";
            timelapse.innerHTML = "00:00";
            timeline.appendChild(timelapse);
        }
        if(this.options.playlist){
            // Toggle playlist button
            const togglePlaylist = document.createElement("div");
            togglePlaylist.className = "togglePlaylist";
            const togglePlaylistIcon = document.createElement("i");
            togglePlaylistIcon.className = "fa-solid fa-bars";
            togglePlaylist.appendChild(togglePlaylistIcon);
            controlsDiv.appendChild(togglePlaylist);
            // Create the playlist container
            const playlistDiv = document.createElement("div");
            playlistDiv.className = "playlist hide";
            //playerSection.appendChild(playlistDiv);
            row2.appendChild(playlistDiv);
        }

        row1.appendChild(controlsDiv);
        playerSection.appendChild(row1);
        // Create the progress bar
        const progressBarDiv = document.createElement("div");
        progressBarDiv.className = "progressBar";
        const seekBarDiv = document.createElement("div");
        seekBarDiv.className = "seekBar";
        progressBarDiv.appendChild(seekBarDiv);
        timeline.appendChild(progressBarDiv);
        row1.appendChild(timeline);
        playerSection.appendChild(row2);
        // add style to playerSection
        const style = document.createElement("style");
        style.textContent = `.hide{display: none !important;}.cpplayer{display:flex;flex-direction:column;border:2px solid #900;border-radius: 8px;background-color: #bb1111;padding:16px;}.active_track{background-color: #000;color:#fff;padding:8px;}.track:last-child{border-bottom: none!important;}.equalizer {display: flex; gap: 5px;height: 100px;width: 200px;align-items: flex-end; background: rgba(255, 255, 255, 0.05);padding: 10px;border-radius: 10px;overflow: hidden;}.bar {width: 20px; height: 100%;background: linear-gradient(180deg, #ff3d00, #ff9100);transform-origin: bottom;transform: scaleY(0.02);transition: transform 0.1s ease-out;}.audioInfo{background:linear-gradient(180deg, #999, #333)}`;
        playerSection.appendChild(style);
        return playerSection;
    }

    applyStyles(styleOptions) {
        // Apply styles to the main player container
        if (styleOptions.container) {
            Object.assign(this.playerSection.style, this.styleOptions.container);
        }
        const playerSection = this.playerSection;
        if(styleOptions.cpplayer){
            Object.assign(playerSection.style, this.styleOptions.cpplayer);
        }
        // Apply styles to controls
        const controls = this.playerSection.querySelector(".controls");
        if (styleOptions.controls) {
            Object.assign(controls.style, this.styleOptions.controls);
        }
        // Apply styles to progress bar
        const progressBar = this.playerSection.querySelector(".progressBar");
        if (styleOptions.progressBar) {
            Object.assign(progressBar.style, this.styleOptions.progressBar);
        }
        if(this.options.audioInfo){
            const audioInfo = this.playerSection.querySelector(".audioInfo");
            if (styleOptions.audioInfo) {
                Object.assign(audioInfo.style, this.styleOptions.audioInfo);
            }
            const audioInfoImage = this.playerSection.querySelector(".audioInfoImage");
            if (styleOptions.audioInfoImage) {
                Object.assign(audioInfoImage.style, this.styleOptions.audioInfoImage);
            }
            const audioInfoDescContainer = this.playerSection.querySelector(".audioInfoDescContainer");
            if (styleOptions.audioInfoDescContainer) {
                Object.assign(audioInfoDescContainer.style, this.styleOptions.audioInfoDescContainer);
            }
        }
        if(this.options.playlist){
            // Apply styles to playlist
            const playlist = this.playerSection.querySelector(".playlist");
            if (styleOptions.playlist) {
                Object.assign(playlist.style, this.styleOptions.playlist);
            }

            const playlistItems = playlist.querySelectorAll(".playlistItem");
            playlistItems.forEach(item => {
                if (styleOptions.playlistItem) {
                    Object.assign(item.style, this.styleOptions.playlistItem);
                }
            });

            const tracks = playlist.querySelectorAll(".track");
            tracks.forEach(item => {
                if (styleOptions.track) {
                    Object.assign(item.style, this.styleOptions.track);
                }
            });
        }

        const Row1 = this.playerSection.querySelector(".row1");
        if (styleOptions.row1) {
            Object.assign(Row1.style, this.styleOptions.row1);
        }
        const Row2 = this.playerSection.querySelector(".row2");
        if (styleOptions.row2) {
            Object.assign(Row2.style, this.styleOptions.row2);
        }

        const playBtn = this.playerSection.querySelector(".playBtn");
        if (styleOptions.playBtn) {
            Object.assign(playBtn.style, this.styleOptions.playBtn);
        }

        const pauseBtn = this.playerSection.querySelector(".pauseBtn");
        if (styleOptions.pauseBtn) {
            Object.assign(pauseBtn.style, this.styleOptions.pauseBtn);
        }
        if(this.options.showSoundControl){
            const muteBtn = this.playerSection.querySelector(".muteBtn");
            if (styleOptions.muteBtn) {
                Object.assign(muteBtn.style, this.styleOptions.muteBtn);
            }

            const unmuteBtn = this.playerSection.querySelector(".unmuteBtn");
            if (styleOptions.unmuteBtn) {
                Object.assign(unmuteBtn.style, this.styleOptions.unmuteBtn);
            }

            const volumeContainer = this.playerSection.querySelector('.vol-container');
            if(styleOptions.volContainer){
                Object.assign(volumeContainer.style, this.styleOptions.volContainer);
            }

            const volumeControl = this.playerSection.querySelector('.volume-control');
            if(styleOptions.volumeControl){
                Object.assign(volumeControl.style, this.styleOptions.volumeControl);
            }
        }
        if(this.options.seekControls){
            const seekForwardButton = this.playerSection.querySelector(".seekForward");
            if (styleOptions.seekForwardBtn) {
                Object.assign(seekForwardButton.style, this.styleOptions.seekForwardBtn);
            }
            const seekBackwordButton = this.playerSection.querySelector(".seekBackward");
            if (styleOptions.seekBackwardBtn) {
                Object.assign(seekBackwordButton.style, this.styleOptions.seekBackwardBtn);
            }
            const seekControls = this.playerSection.querySelector(".seekControls");
        if (styleOptions.seekControls) {
            Object.assign(seekControls.style, this.styleOptions.seekControls);
        }
        }
        const timeline = this.playerSection.querySelector(".timeline");
        if (styleOptions.timeline) {
            Object.assign(timeline.style, this.styleOptions.timeline);
        }

        const seekBar = this.playerSection.querySelector(".seekBar");
        if (styleOptions.seekBar) {
            Object.assign(seekBar.style, this.styleOptions.seekBar);
        }
        if(this.options.showTimeLapse){
            const timelapse = this.playerSection.querySelector(".timelapse");
            if (styleOptions.timelapse) {
                Object.assign(timelapse.style, this.styleOptions.timelapse);
            }
        }

        if(this.options.playlist){

            const playlistContainer = this.playerSection.querySelector(".playlist");
            if (styleOptions.playlistContainer) {
                Object.assign(playlistContainer.style, this.styleOptions.playlistContainer);
            }

            const togglePlaylistButton = this.playerSection.querySelector(".togglePlaylist");
            if (styleOptions.togglePlaylistBtn) {
                Object.assign(togglePlaylistButton.style, styleOptions.togglePlaylistBtn);
            }

            const PlaylistPlayIcons = this.playerSection.querySelectorAll(".PlaylistPlayIcon");
            if (styleOptions.PlaylistPlayIcons) {
                PlaylistPlayIcons.forEach(icon => {
                    Object.assign(icon.style, styleOptions.PlaylistPlayIcons);
                });
            }
        }
        if(this.options.nextPreviousControls){
            const trackControls = this.playerSection.querySelector(".trackControls");
            if (styleOptions.trackControls) {
                Object.assign(trackControls.style, this.styleOptions.trackControls);
            }
            const prevTrackButton = this.playerSection.querySelector(".prevTrack");
            if (styleOptions.prevTrackBtn) {
                Object.assign(prevTrackButton.style, styleOptions.prevTrackBtn);
            }

            const nextTrackButton = this.playerSection.querySelector(".nextTrack");
            if (styleOptions.nextTrackBtn) {
                Object.assign(nextTrackButton.style, styleOptions.nextTrackBtn);
            }
        }
    }
    initUI(playerId) {
        const playerSection = document.getElementById(playerId);
        this.playButton = playerSection.querySelector(".playBtn");
        this.pauseButton = playerSection.querySelector(".pauseBtn");
        if(this.options.showSoundControl){
            this.muteButton = playerSection.querySelector(".muteBtn");
            this.unmuteButton = playerSection.querySelector(".unmuteBtn");
            this.volumeControl = playerSection.querySelector('.volume-control');
        }
        this.seekBar = playerSection.querySelector(".seekBar");
        if(this.options.showTimeLapse){
            this.timeLapse = playerSection.querySelector(".timelapse");
        }
        if(this.options.playlist){
        this.playlistContainer = playerSection.querySelector(".playlist");
        this.togglePlaylistButton = playerSection.querySelector(".togglePlaylist");
        this.PlaylistPlayIcons = playerSection.querySelectorAll(".PlaylistPlayIcon");
        }

        if(this.options.nextPreviousControls){
            this.prevTrackButton = playerSection.querySelector(".prevTrack");
            this.nextTrackButton = playerSection.querySelector(".nextTrack");
        }
        if(this.options.seekControls){
            this.seekBackwordButton = playerSection.querySelector(".seekBackward");
            this.seekForwardButton = playerSection.querySelector(".seekForward");
        }
        if(this.options.audioInfo){
            this.activeAudioInfoImage = playerSection.querySelector(".audioInfoImage");
            this.activeAudioInfoDescContainer =  playerSection.querySelector(".audioInfoDescContainer");
            this.activeAudioInfoTitle = playerSection.querySelector(".audioInfoTitle");
            this.activeAudioInfoArtist = playerSection.querySelector(".audioInfoArtist");
            this.activeAudioInfoAlbum = playerSection.querySelector(".audioInfoAlbum");
            this.activeAudioInfoYear = playerSection.querySelector(".audioInfoYear");

            
        }

        this.bars = playerSection.querySelectorAll(".bar");

        

    }

    initEventListeners() {
        this.playButton.addEventListener("click", (e)=>{ this.play(e)}, false);
        this.pauseButton.addEventListener("click", () => this.pause());
        if (this.options.showSoundControl) {
            this.muteButton.addEventListener("click", () => this.mute());
            this.unmuteButton.addEventListener("click", () => this.unmute());
            this.volumeControl.addEventListener("input", (e) => this.updateVolume(e));
        }
        if (this.options.nextPreviousControls) {
            this.prevTrackButton.addEventListener("click", () => this.prevTrack());
            this.nextTrackButton.addEventListener("click", () => this.nextTrack());
        }
        if (this.options.playlist) {
            this.togglePlaylistButton.addEventListener("click", () => {
                this.playlistContainer.classList.toggle("hide");
            });
        }
        if (this.options.seekControls) {
            this.seekForwardButton.addEventListener("click", () => this.seekForward());
            this.seekBackwordButton.addEventListener("click", () => this.seekBackward());
        }
        this.seekBar.parentElement.addEventListener("click", (e) => this.seek(e));
        this.music.addEventListener("timeupdate", () => this.updateSeekBar());
        if (this.options.showTimeLapse) {
            this.music.addEventListener("timeupdate", () => this.updateTimelapse());
        }
        this.music.addEventListener("ended", () => this.nextTrack());
    
        document.addEventListener('click', this.initialize_animation.bind(this));
        
    }

    initialize_animation(){
        if (!this.animation_audioContext ) {
            // Initialize AudioContext only once
            this.animation_audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.animation_analyser = this.animation_audioContext.createAnalyser();
            this.animation_analyser.fftSize = 64; // Adjust for better resolution
            this.animation_source = this.animation_audioContext.createMediaElementSource(this.music);
            this.animation_source.connect(this.animation_analyser);
            this.animation_analyser.connect(this.animation_audioContext.destination);
            this.animation_dataArray = new Uint8Array(this.animation_analyser.frequencyBinCount);

          }
    }
    
    startAnimateBars() {
        this.initialize_animation();
        this.animation_analyser.getByteFrequencyData(this.animation_dataArray);
        if (this?.bars.length > 0) {
            this?.bars.forEach((bar, i) => {
                const value = this.animation_dataArray[i] || 0;
                const barHeight = Math.max(value / 255, 0.02); // Scale between 0.02 and 1.
                bar.style.transform = `scaleY(${barHeight})`; // Scale within equalizer bounds
            });
        }
        // Pass the function reference, not the result of calling it
        requestAnimationFrame(this.startAnimateBars.bind(this)); 
    }
    
    stopAnimateBars(){
        this.bars.forEach((bar) => (bar.style.transform = 'scaleY(0.02)')); // Reset bars on pause
    }
    play(e) {
        //e.stopPropagation();
        //e.preventDefault();

        this.music.play();
        this.playButton.classList.add("hide");
        this.pauseButton.classList.remove("hide");  
        this.startAnimateBars();

        this.readMetadata(this.currentTrack).then(res=>{
            this.activeAudioTags = res;
        });
    }

    pause() {
        this.music.pause();
        this.playButton.classList.remove("hide");
        this.pauseButton.classList.add("hide");
        this.stopAnimateBars();
    }

    mute() {
        this.music.muted = true;
        this.muteButton.classList.add("hide");
        this.unmuteButton.classList.remove("hide");
    }

    unmute() {
        this.music.muted = false;
        this.muteButton.classList.remove("hide");
        this.unmuteButton.classList.add("hide");
    }

    updateVolume(e) {
        this.music.volume = parseInt(e.target.value) / 10;
    }

    seekForward() {
        this.music.currentTime += 10;
    }

    seekBackward() {
        this.music.currentTime -= 10;
    }

    seek(e) {
        const seekBarWidth = this.seekBar.parentElement.offsetWidth;
        const clickX = e.offsetX;
        this.music.currentTime = (clickX / seekBarWidth) * this.music.duration;
    }

    updateSeekBar() {
        const seek = (this.music.currentTime / this.music.duration) * 100;
        this.seekBar.style.width = `${seek}%`;
    }
    updateTimelapse() {
        // Fallback to 0 if the properties are invalid
        const currentTime = isFinite(this.music?.currentTime) ? this.music.currentTime : 0;
        const duration = isFinite(this.music?.duration) ? this.music.duration : 0;

        const c_minutes = Math.floor(currentTime / 60);
        const c_seconds = Math.floor(currentTime % 60);
        const t_minutes = Math.floor(duration / 60);
        const t_seconds = Math.floor(duration % 60);
        // Format the time with leading zeros for seconds
        const formattedTime = `${c_minutes.toString().split(".")[0]}:${c_seconds < 10 ? "0" : ""}${c_seconds} / ${t_minutes.toString().split(".")[0]}:${t_seconds < 10 ? "0" : ""}${t_seconds}`;
        this.timeLapse.innerHTML = formattedTime;
    }

    nextTrack(e) {
        this.trackIndex = (this.trackIndex + 1) % this.playlist.length;
        this.changeTrack(e);
    }

    prevTrack(e) {
        this.trackIndex = (this.trackIndex - 1 + this.playlist.length) % this.playlist.length;
        this.changeTrack(e);
    }

    changeTrack(e) {
        this.currentTrack = this.playlist[this.trackIndex];
        this.music.src = this.currentTrack;
        this.play();
        this.updateActiveTrack();
    }

    updateActiveTrack() {
        if(this.options.playlist){
            const tracks = this.playlistContainer.querySelectorAll(".track");
            tracks.forEach((track, index) => {
                if(index === this.trackIndex)
                track.classList.add("active_track");
                else
                track.classList.remove("active_track");
            });
        }
    }

    renderAudioInfo = ($tags)=>{
        if(this.options.audioInfo && $tags){
            if($tags.image){
                this.activeAudioInfoImage.src = $tags.image;
            }else{
                this.activeAudioInfoImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKYAAACUCAMAAAAu5KLjAAAATlBMVEXv8fNod4dgcIH3+Prr7e91g5GdprDk5+pUZnjY3ODz9PZldIXf4+b5+vpcbX5aa32krLWSnaeqsrp9ipe+xMuzusLR1dqKlqHKz9W4v8UC8A7gAAACeklEQVR4nO2a7ZaCIBCGFQptKEXRsvu/0bXNTexjYzEZ95z3Of306NMMDCOSJAAAAAAAAAAAAAAAAAAAAAA8QslmPrS45fG0nY012dKWqdDzKeyy8dycRPoJ8kYuqZlt9Uc0hTpA879plnkoIqJm2e1DqXQ8zXwXOFGJlIipGVr3oOkAzU/yTJMk9T/PG3BpkuxaU58zz8cyadLOai2ETo1fE8mjKRs9rJ6l9fJk0aR9cVvji2q9mtbpRHTj4cmhSbtp1+NxAxbNxm3rtN2sVLN1Xzn01uNFjEXzPNG0rmZf8Q9PxiqL5nEyNivnQnm0qe1+0Yzxynarm69mOjW5TnVuHmR4CtIxH4Npx8vkMLfK9t6TaRVqxRBPkY6rkDyXPzXf3I1PrjW9s7kQohAqG7uRc3GLcXmXd7YOKevUqap3iRNLd/4X9cSTs988HJx+k9o8dSkVuRevpHuf1tIh786fWIembB/3woRZm+Z9xofxOeZ9FZrPYnkdnz95X4OmrIunlt9NHq1F83nGh7xX13jya77K+OB5ne/smtK8juU1npe883RII1SXv1r28+iSd+ZoUv3+28GlLrFqEr3J+C3vklXzZSW69zwYPk0yvl+LhFJRN7Xdpscv44OnTrk0vWPpRjV2W0zKb1yyalJi3tXLVWgGZDy6JlEVEsvYux6JCrOMqtlbhn5dj6gZnPGomn0sAypRbE3aVOGWEaMZnvGYmtWssymxNGfFMpamtjPP+UQ66zH3YApOzvwjzY39kKZZVJOCV/Ep4ccb/DT321LMJ1920+Oyg92o2dShx5j+gPwAi5+GBQAAAAAAAAAAAAAAAAAAAGBJvgD+5DZit7mvxgAAAABJRU5ErkJggg==";
            }
            if($tags.TIT2){
            this.activeAudioInfoTitle.innerHTML = "<i class=\"fa-solid fa-music\"></i> <span>" +  $tags.TIT2 + "</span>";
            }else{
                this.activeAudioInfoTitle.innerHTML = "<i class=\"fa-solid fa-music\"></i> <span>" + "Unknown" + "</span>";
            }
            if($tags.TPE1){
            this.activeAudioInfoArtist.innerHTML = "<i class=\"fa-solid fa-user\"></i> " + $tags.TPE1;
            }else{
                this.activeAudioInfoArtist.innerHTML = "<i class=\"fa-solid fa-user\"></i> " + "Unknown";
            }
            if($tags.TALB){
            this.activeAudioInfoAlbum.innerHTML = "<i class=\"fa-solid fa-book\"></i> " + $tags.TALB;
            }else{
                this.activeAudioInfoAlbum.innerHTML = "<i class=\"fa-solid fa-book\"></i> " + "Unknown";
            }
            if($tags.TDRC){
            this.activeAudioInfoYear.innerHTML = "<i class=\"fa-solid fa-calendar\"></i> " + $tags.TDRC;
            }else{
                this.activeAudioInfoYear.innerHTML = "<i class=\"fa-solid fa-calendar\"></i> " + "Unknown";
            }
        }
    }

    renderPlaylist() {
        if(this.options.playlist){
            this.playlist.forEach((track, index) => {
                const div = document.createElement("div");
                let name = track.split("/").pop();
                div.className = "track";
                if (index === this.trackIndex) div.classList.add("active_track");
                div.innerHTML = `<span class="track-number">${index + 1} ${name}</span><i class="fa-solid fa-play PlaylistPlayIcon" data-playlistID="${index}"></i>`;
                this.playlistContainer.appendChild(div);
            });
            this.playlistPlayButtons = this.playerSection.querySelectorAll(".PlaylistPlayIcon");
            this.playlistPlayButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const playlistID = button.getAttribute("data-playlistID");
                    this.playTrack(playlistID);
                    this.updateActiveTrack();
                })
            })
        }
    }

    playTrack(trackIndex) {
        this.trackIndex = trackIndex;
        this.changeTrack();
    }
    async readMetadata(filePath) {
    const file = await fetch(filePath)
                .then(res=>{
                    return res;
                })
                .then(r => {
                    return r.blob();
                }).catch(e => {
                    console.error(e);
                });
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const arrayBuffer = reader.result;
      const tags = CP_Player.parseID3Tags(arrayBuffer);
      this.renderAudioInfo(tags);
    };
    reader.readAsArrayBuffer(file);
}

    async getMediaStream(filePath){
        const file = await fetch(filePath)
                .then(res=>{
                    return res;
                })
                .then(r => {
                    return r.blob();
                }).catch(e => {
                    console.error(e);
                });
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
        return reader.result;
        };
        reader.readAsArrayBuffer(file);
    }


  static parseID3Tags(arrayBuffer) {
    const dataView = new DataView(arrayBuffer);

    // Check if the file starts with the ID3 identifier
    if (
      String.fromCharCode(dataView.getUint8(0)) === "I" &&
      String.fromCharCode(dataView.getUint8(1)) === "D" &&
      String.fromCharCode(dataView.getUint8(2)) === "3"
    ) {
      const version = `${dataView.getUint8(3)}.${dataView.getUint8(4)}`;
      const tagSize = CP_Player.getID3Size(dataView, 6);
      const tags = {};
      let offset = 10; // Start after the ID3 header

      while (offset < tagSize) {
        const frameID = String.fromCharCode(
          dataView.getUint8(offset),
          dataView.getUint8(offset + 1),
          dataView.getUint8(offset + 2),
          dataView.getUint8(offset + 3)
        );

        const frameSize = dataView.getUint32(offset + 4);
        if (frameSize === 0) break; // Stop if the frame size is invalid

        if (frameID === "APIC") {
          tags.image = CP_Player.parseAPICFrame(dataView, offset + 10, frameSize);
        } else {
          const encoding = dataView.getUint8(offset + 10);
          const frameData = new TextDecoder(encoding === 1 ? "utf-16" : "utf-8").decode(
            new DataView(arrayBuffer, offset + 11, frameSize - 1)
          );
          tags[frameID] = frameData;
        }
        offset += 10 + frameSize;
      }
      return tags;
    } else {
      console.error("No ID3 tags found.");
      return null;
    }
  }

  static parseAPICFrame(dataView, offset, frameSize) {
    let index = offset;

    // Parse MIME type (null-terminated string)
    let mimeType = "";
    while (dataView.getUint8(index) !== 0) {
      mimeType += String.fromCharCode(dataView.getUint8(index++));
    }
    index++; // Skip the null byte

    // Skip the picture type byte and description (null-terminated string)
    index++; // Picture type
    while (dataView.getUint8(index) !== 0) {
      index++;
    }
    index++; // Skip the null byte

    // The remaining data is the image binary
    const imageData = new Uint8Array(dataView.buffer, index, frameSize - (index - offset));

    // Convert image data to Base64
    const base64String =  CP_Player.arrayBufferToBase64(imageData);
    return `data:${mimeType};base64,${base64String}`;
  }

  static arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;

    // Process the data in chunks to avoid stack overflow
    for (let i = 0; i < len; i += 10000) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + 10000));
    }

    return btoa(binary);
  }

  static getID3Size(dataView, offset) {
    // ID3 size uses "syncsafe integers" (7 bits per byte, highest bit is 0)
    const size =
      ((dataView.getUint8(offset) & 0x7f) << 21) |
      ((dataView.getUint8(offset + 1) & 0x7f) << 14) |
      ((dataView.getUint8(offset + 2) & 0x7f) << 7) |
      (dataView.getUint8(offset + 3) & 0x7f);
    return size;
  }

  /***** Dancing Bars ***** */

  createDancingBars(container) {
    const equalizer = document.createElement("div");
    equalizer.classList.add("equalizer");
    
    this.equalizer = equalizer;
    for (let i = 0; i < 5; i++) {
      const bar = document.createElement("div");
      bar.classList.add("bar");
      bar.style.animationDelay = `${i * 0.1}s`;
      this.equalizer.appendChild(bar);
    }
    container.appendChild(equalizer);
  }
}